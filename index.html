<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Liquid Mouse Pro</title>
    <style>
        :root {
            /* Palette "Deep Liquid" */
            --bg-color: #2b2e4a; 
            --glass-surface: rgba(255, 255, 255, 0.03); 
            --text-subtle: rgba(255, 255, 255, 0.3); 
            
            /* Ombre stato NORMALE (Rilievo) */
            --shadow-out: 
                10px 10px 20px rgba(0, 0, 0, 0.35), 
                -8px -8px 16px rgba(255, 255, 255, 0.04); 

            /* Ombre stato PREMUTO (Incassato) */
            --shadow-in: 
                inset 6px 6px 12px rgba(0, 0, 0, 0.25), 
                inset -4px -4px 10px rgba(255, 255, 255, 0.03); 
        }

        body {
            margin: 0;
            height: 100vh;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* Stile Base Elementi Fluidi */
        .fluid-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 35px; /* Curve morbide */
            border: 1px solid rgba(255, 255, 255, 0.02);
            box-shadow: var(--shadow-out);
            
            /* Transizione rapida per feedback immediato */
            transition: all 0.1s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-subtle);
            font-size: 16px;
            font-weight: 500;
        }

        /* CLASSE ATTIVA (Applicata via JS per effetto pressione) */
        .fluid-pressed {
            box-shadow: var(--shadow-in) !important;
            transform: scale(0.96); /* Effetto compressione fisica */
            background: rgba(0,0,0,0.1); /* Leggero oscuramento */
            color: rgba(255, 255, 255, 0.6);
        }

        /* Layout Touchpad */
        #touchpad {
            flex: 1;
            height: auto;
            margin-bottom: 25px;
        }

        /* Barra Scroll Verticale */
        #scrollbar {
            width: 5%;
            height: auto;
            margin-bottom: 25px;
            margin-left: 2%;
            position: relative;
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(136, 255, 204, 0.1);
            box-shadow: var(--shadow-out);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(136, 255, 204, 0.4);
        }

        /* Contenitore Touchpad + Scrollbar */
        .touchpad-container {
            display: flex;
            align-items: stretch;
            width: 95%;
            flex: 1;
            margin-bottom: 25px;
            gap: 0;
        }

        /* Layout Pulsanti */
        .buttons-container {
            width: 88%;
            height: 16%;
            display: flex;
            justify-content: space-between;
        }

        .mouse-btn {
            width: 31%; /* Spazio equo per 3 tasti */
            height: 100%;
            border-radius: 28px;
            cursor: pointer;
        }

        /* Input nascosto per tastiera */
        #hidden-input {
            position: absolute;
            top: -2000px;
            opacity: 0;
            font-size: 16px; 
        }

        /* Status */
        #status {
            position: absolute;
            top: 40px;
            color: var(--text-subtle);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.5;
        }

        /* Display Testo Digitato */
        #text-display {
            position: fixed;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(136, 255, 204, 0.15);
            border-radius: 16px;
            padding: 12px 16px;
            color: rgba(136, 255, 204, 0.9);
            font-size: 16px;
            font-family: 'Courier New', monospace;
            font-weight: 500;
            min-height: 32px;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-all;
            overflow-y: auto;
            max-height: 80px;
            display: none;
            z-index: 100;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.1), -8px -8px 16px rgba(255, 255, 255, 0.02);
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        #text-display.active {
            display: block !important;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Pannello Configurazione */
        .config-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .config-panel.hidden {
            display: none;
        }

        .config-content {
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            border-radius: 35px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 90%;
        }

        .config-content h1 {
            color: rgba(255,255,255,0.7);
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        .config-content p {
            color: var(--text-subtle);
            font-size: 14px;
            margin: 10px 0;
        }

        .config-input {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: rgba(255,255,255,0.8);
            font-size: 16px;
            margin: 20px 0;
            width: 100%;
            box-sizing: border-box;
        }

        .config-input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        .config-btn {
            background: rgba(136, 255, 204, 0.2);
            border: 1px solid rgba(136, 255, 204, 0.3);
            border-radius: 12px;
            padding: 12px 24px;
            color: rgba(136, 255, 204, 0.9);
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .config-btn:active {
            background: rgba(136, 255, 204, 0.4);
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <div class="config-panel" id="configPanel">
        <div class="config-content">
            <h1>üñ±Ô∏è Liquid Mouse</h1>
            <p>Inserisci l'indirizzo IP del computer</p>
            <input type="text" id="ipInput" class="config-input" placeholder="Es: 192.168.1.100" autocomplete="off">
            <p style="font-size: 12px; margin-top: 20px;">Leggi il README per trovare l'IP</p>
            <button class="config-btn" id="connectBtn">CONNETTI</button>
        </div>
    </div>

    <div id="status">Connecting...</div>

    <div id="text-display"></div>

    <input type="text" id="hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off">

    <div class="touchpad-container">
        <div id="touchpad" class="fluid-panel"></div>
        <div id="scrollbar" class="fluid-panel"></div>
    </div>

    <div class="buttons-container">
        <div id="btn-left" class="fluid-panel mouse-btn">L</div>
        
        <div id="btn-keyboard" class="fluid-panel mouse-btn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M7 16h10"/>
            </svg>
        </div>

        <div id="btn-right" class="fluid-panel mouse-btn">R</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const hiddenInput = document.getElementById('hidden-input');
        const configPanel = document.getElementById('configPanel');
        const ipInput = document.getElementById('ipInput');
        const connectBtn = document.getElementById('connectBtn');
        
        let ws = null;

        // --- 0. CARICAMENTO IP DA STORAGE ---
        function loadIP() {
            return localStorage.getItem('liquidMouseIP') || '';
        }

        function saveIP(ip) {
            localStorage.setItem('liquidMouseIP', ip);
        }

        // --- 1. CONNESSIONE WEBSOCKET ---
        function connectServer(ip) {
            if (!ip.trim()) {
                alert('Inserisci un indirizzo IP valido');
                return;
            }

            const wsUrl = `ws://${ip.trim()}:8765`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusDiv.innerText = "LINKED";
                statusDiv.style.color = "#88ffcc";
                configPanel.classList.add('hidden');
                saveIP(ip.trim());
            };

            ws.onclose = () => {
                statusDiv.innerText = "OFFLINE";
                statusDiv.style.color = "#ff8888";
            };

            ws.onerror = () => {
                statusDiv.innerText = "ERRORE";
                statusDiv.style.color = "#ff6666";
            };
        }

        // --- 2. GESTIONE CONFIGURAZIONE ---
        connectBtn.addEventListener('click', () => {
            connectServer(ipInput.value);
        });

        ipInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                connectServer(ipInput.value);
            }
        });

        // Carica IP precedente e mostra pannello se non disponibile
        const savedIP = loadIP();
        if (savedIP) {
            ipInput.value = savedIP;
            connectServer(savedIP);
        }

        // --- 3. LOGICA MOVIMENTO FLUIDO (Accumulator Pattern) ---
        let moveX = 0, moveY = 0, isMoving = false;
        
        // Loop a 60fps per inviare i dati accumulati
        setInterval(() => {
            if (isMoving && ws && ws.readyState === WebSocket.OPEN && (moveX !== 0 || moveY !== 0)) {
                ws.send(JSON.stringify({type: 'move', x: moveX, y: moveY}));
                console.log(`Movimento inviato: x=${moveX}, y=${moveY}`);
                moveX = 0; moveY = 0;
                isMoving = false;
            }
        }, 16); // 16ms = ~60fps

        const pad = document.getElementById('touchpad');
        let lastX = 0, lastY = 0;
        let touchActive = false;

        pad.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchActive = true;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            moveX = 0; moveY = 0;
            console.log('Touchpad: touchstart');
        }, {passive: false});

        pad.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!touchActive) return;
            const cx = e.touches[0].clientX;
            const cy = e.touches[0].clientY;
            moveX += (cx - lastX);
            moveY += (cy - lastY);
            isMoving = true;
            lastX = cx;
            lastY = cy;
            console.log(`Touchpad: movimento accumulato x=${moveX}, y=${moveY}`);
        }, {passive: false});

        pad.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchActive = false;
            console.log('Touchpad: touchend');
        }, {passive: false});

        pad.addEventListener('touchcancel', (e) => {
            touchActive = false;
            console.log('Touchpad: touchcancel');
        }, {passive: false});

        // --- 3.5. LOGICA SCROLL VERTICALE (Barra Laterale) ---
        let scrollAccumulator = 0;
        const scrollbar = document.getElementById('scrollbar');
        let scrollTouchActive = false;
        let scrollLastY = 0;

        setInterval(() => {
            if (scrollTouchActive && ws && ws.readyState === WebSocket.OPEN && Math.abs(scrollAccumulator) >= 1) {
                const scrollAmount = Math.round(scrollAccumulator / 2); // Aumenta sensibilit√†
                if (scrollAmount !== 0) {
                    ws.send(JSON.stringify({type: 'scroll', amount: scrollAmount}));
                    console.log(`Scroll inviato: ${scrollAmount}`);
                }
                scrollAccumulator = 0;
            }
        }, 16); // 16ms = ~60fps

        scrollbar.addEventListener('touchstart', (e) => {
            e.preventDefault();
            scrollTouchActive = true;
            scrollLastY = e.touches[0].clientY;
            scrollAccumulator = 0;
            console.log('Scrollbar: touchstart');
        }, {passive: false});

        scrollbar.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!scrollTouchActive) return;
            const cy = e.touches[0].clientY;
            const delta = cy - scrollLastY;
            scrollAccumulator += delta * 1.5; // Aumenta sensibilit√† del 50%
            scrollLastY = cy;
            console.log(`Scrollbar: movimento accumulato=${scrollAccumulator}`);
        }, {passive: false});

        scrollbar.addEventListener('touchend', (e) => {
            e.preventDefault();
            scrollTouchActive = false;
            console.log('Scrollbar: touchend');
        }, {passive: false});

        scrollbar.addEventListener('touchcancel', (e) => {
            scrollTouchActive = false;
            console.log('Scrollbar: touchcancel');
        }, {passive: false});

        // --- 4. LOGICA CLICK E TASTIERA ---
        const sendClick = (btn) => {
            if(ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'click', btn: btn}));
                console.log(`Click inviato: ${btn}`);
            }
        };

        // Click Mouse
        document.getElementById('btn-left').addEventListener('click', () => {
            console.log('Left click');
            sendClick('left');
        });
        document.getElementById('btn-right').addEventListener('click', () => {
            console.log('Right click');
            sendClick('right');
        });

        // Apertura Tastiera
        document.getElementById('btn-keyboard').addEventListener('click', () => {
            console.log('Keyboard button clicked, focusing input');
            hiddenInput.value = ''; // Svuota prima di focusare
            hiddenInput.focus();
            if (hiddenInput.setSelectionRange) {
                hiddenInput.setSelectionRange(0, 0);
            }
            console.log('Input focused');
        });

        // --- DISPLAY TESTO DIGITATO ---
        const textDisplay = document.getElementById('text-display');
        let displayedText = '';
        let displayTimeout;

        function updateTextDisplay(char) {
            if (char === '‚å´') {
                displayedText = displayedText.slice(0, -1);
            } else if (char === '‚Üµ') {
                displayedText += '\n';
            } else {
                displayedText += char;
            }
            
            console.log(`Aggiornamento display: "${displayedText}"`);
            textDisplay.textContent = displayedText;
            textDisplay.classList.add('active');
            textDisplay.style.display = 'block';
            
            clearTimeout(displayTimeout);
            displayTimeout = setTimeout(() => {
                textDisplay.classList.remove('active');
                textDisplay.style.display = 'none';
                displayedText = '';
            }, 3000);
        }

        // Invio tasti digitati - Compatibile con Safari iOS
        let previousValue = '';
        
        hiddenInput.addEventListener('input', (e) => {
            if(!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const currentValue = hiddenInput.value;
            console.log(`Input: previous="${previousValue}", current="${currentValue}"`);
            
            // Confronta i valori per determinare cosa √® stato aggiunto
            if (currentValue.length > previousValue.length) {
                // Carattere aggiunto
                const addedChar = currentValue.substring(previousValue.length);
                console.log(`Carattere aggiunto: "${addedChar}"`);
                
                for (let char of addedChar) {
                    ws.send(JSON.stringify({type: 'text', char: char}));
                    updateTextDisplay(char);
                }
            } else if (currentValue.length < previousValue.length) {
                // Backspace
                const deletedCount = previousValue.length - currentValue.length;
                console.log(`Backspace x${deletedCount}`);
                
                for (let i = 0; i < deletedCount; i++) {
                    ws.send(JSON.stringify({type: 'key', key: 'backspace'}));
                    updateTextDisplay('‚å´');
                }
            }
            
            previousValue = currentValue;
        }, {passive: true});

        hiddenInput.addEventListener('keydown', (e) => {
            console.log(`Keydown: ${e.key}`);
            if(!ws || ws.readyState !== WebSocket.OPEN) return;
            
            if (e.key === 'Enter') {
                e.preventDefault();
                ws.send(JSON.stringify({type: 'key', key: 'enter'}));
                console.log('Enter inviato');
                updateTextDisplay('‚Üµ');
                previousValue = '';
                hiddenInput.value = '';
            } else if (e.key === 'Backspace') {
                // Su iOS il Backspace potrebbe non triggerare input event
                e.preventDefault();
                previousValue = hiddenInput.value.slice(0, -1);
                hiddenInput.value = previousValue;
                ws.send(JSON.stringify({type: 'key', key: 'backspace'}));
                console.log('Backspace inviato (keydown)');
                updateTextDisplay('‚å´');
            }
        }, {passive: false});

        // --- 5. LOGICA VISIVA (Effetto Pressione Unificato) ---
        function attachPressEffect(id) {
            const el = document.getElementById(id);
            const add = () => el.classList.add('fluid-pressed');
            const remove = () => el.classList.remove('fluid-pressed');
            
            el.addEventListener('touchstart', add, {passive: true});
            el.addEventListener('touchend', remove, {passive: true});
            el.addEventListener('touchcancel', remove, {passive: true});
        }

        attachPressEffect('btn-left');
        attachPressEffect('btn-right');
        attachPressEffect('btn-keyboard');
        attachPressEffect('touchpad');
        attachPressEffect('scrollbar');

    </script>
</body>
</html>
