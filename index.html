<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Liquid Mouse</title>
    <style>
        :root {
            /* Design System: Deep Liquid */
            --bg-color: #2b2e4a; 
            --glass-surface: rgba(255, 255, 255, 0.03); 
            --text-subtle: rgba(255, 255, 255, 0.3); 
            
            --shadow-out: 
                10px 10px 20px rgba(0, 0, 0, 0.35), 
                -8px -8px 16px rgba(255, 255, 255, 0.04); 

            --shadow-in: 
                inset 6px 6px 12px rgba(0, 0, 0, 0.25), 
                inset -4px -4px 10px rgba(255, 255, 255, 0.03); 
        }

        body {
            margin: 0;
            height: 100vh;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* Componenti Fluidi */
        .fluid-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 35px;
            border: 1px solid rgba(255, 255, 255, 0.02);
            box-shadow: var(--shadow-out);
            transition: all 0.1s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-subtle);
            font-size: 16px;
            font-weight: 500;
        }

        .fluid-pressed {
            box-shadow: var(--shadow-in) !important;
            transform: scale(0.96);
            background: rgba(0,0,0,0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .drag-active {
            background: rgba(255, 204, 0, 0.15) !important;
            border: 1px solid rgba(255, 204, 0, 0.4) !important;
            color: #ffcc00 !important;
            box-shadow: inset 0 0 15px rgba(255, 204, 0, 0.1) !important;
        }

        #touchpad {
            flex: 1;
            height: auto;
            margin-bottom: 25px;
        }

        #scrollbar {
            width: 5%;
            height: auto;
            margin-bottom: 25px;
            margin-left: 2%;
            position: relative;
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(136, 255, 204, 0.1);
            box-shadow: var(--shadow-out);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(136, 255, 204, 0.4);
        }

        .touchpad-container {
            display: flex;
            align-items: stretch;
            width: 95%;
            flex: 1;
            margin-bottom: 25px;
            gap: 0;
        }

        .buttons-container {
            width: 95%; 
            height: 16%;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .mouse-btn {
            flex: 1;
            height: 100%;
            border-radius: 24px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 14px;
        }

        /* Input nascosto per cattura tastiera */
        #hidden-input {
            position: absolute;
            top: -2000px;
            opacity: 0;
            font-size: 16px; 
        }

        #status {
            position: absolute;
            top: 40px;
            color: var(--text-subtle);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.5;
        }

        /* Display Feedback Testuale */
        #text-display {
            position: fixed;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(136, 255, 204, 0.15);
            border-radius: 16px;
            padding: 12px 16px;
            color: rgba(136, 255, 204, 0.9);
            font-size: 16px;
            font-family: 'Courier New', monospace;
            font-weight: 500;
            min-height: 32px;
            line-height: 1.4;
            display: none;
            z-index: 100;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.1);
        }

        #text-display.active {
            display: block !important;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pannello Configurazione Iniziale */
        .config-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .config-panel.hidden {
            display: none;
        }

        .config-content {
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            border-radius: 35px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 90%;
        }

        .config-content h1 {
            color: #ffffff;
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        .config-content p {
            color: #ffffff;
            font-size: 14px;
            margin: 10px 0;
        }

        .config-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 12px 16px;
            color: #ffffff;
            font-size: 16px;
            margin: 20px 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .config-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .config-btn {
            background: rgba(136, 255, 204, 0.2);
            border: 1px solid rgba(136, 255, 204, 0.3);
            border-radius: 12px;
            padding: 12px 24px;
            color: rgba(136, 255, 204, 0.9);
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="config-panel" id="configPanel">
        <div class="config-content">
            <h1>üñ±Ô∏è Liquid Mouse</h1>
            <p>Inserisci l'indirizzo IP del Server</p>
            <input type="text" id="ipInput" class="config-input" placeholder="Es: 192.168.1.100" autocomplete="off">
            <button class="config-btn" id="connectBtn">CONNETTI</button>
        </div>
    </div>

    <div id="status">In attesa...</div>
    <div id="text-display"></div>
    <input type="text" id="hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off">

    <div class="touchpad-container">
        <div id="touchpad" class="fluid-panel"></div>
        <div id="scrollbar" class="fluid-panel"></div>
    </div>

    <div class="buttons-container">
        <div id="btn-left" class="fluid-panel mouse-btn">L</div>
        
        <div id="btn-drag" class="fluid-panel mouse-btn" style="color: #ffcc00;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        </div>

        <div id="btn-select-all" class="fluid-panel mouse-btn" style="font-size: 12px; line-height: 1.2;">
            <b>SEL</b><br>ALL
        </div>

        <div id="btn-keyboard" class="fluid-panel mouse-btn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M7 16h10"/>
            </svg>
        </div>

        <div id="btn-right" class="fluid-panel mouse-btn">R</div>
    </div>

    <script>
        // --- LOGICA CLIENT ---
        const statusDiv = document.getElementById('status');
        const hiddenInput = document.getElementById('hidden-input');
        const configPanel = document.getElementById('configPanel');
        const ipInput = document.getElementById('ipInput');
        const connectBtn = document.getElementById('connectBtn');
        
        let ws = null;

        function loadIP() { return localStorage.getItem('liquidMouseIP') || ''; }
        function saveIP(ip) { localStorage.setItem('liquidMouseIP', ip); }

        function connectServer(ip) {
            if (!ip.trim()) { alert('Inserire un indirizzo IP valido.'); return; }
            const wsUrl = `ws://${ip.trim()}:8765`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusDiv.innerText = "CONNESSO";
                statusDiv.style.color = "#88ffcc";
                configPanel.classList.add('hidden');
                saveIP(ip.trim());
            };
            ws.onclose = () => {
                statusDiv.innerText = "OFFLINE";
                statusDiv.style.color = "#ff8888";
            };
            ws.onerror = () => {
                statusDiv.innerText = "ERRORE";
                statusDiv.style.color = "#ff6666";
            };
        }

        connectBtn.addEventListener('click', () => connectServer(ipInput.value));
        ipInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') connectServer(ipInput.value); });

        const savedIP = loadIP();
        if (savedIP) { ipInput.value = savedIP; connectServer(savedIP); }

        // --- GESTIONE MOVIMENTO CURSORE ---
        let moveX = 0, moveY = 0, isMoving = false;
        setInterval(() => {
            if (isMoving && ws && ws.readyState === WebSocket.OPEN && (moveX !== 0 || moveY !== 0)) {
                ws.send(JSON.stringify({type: 'move', x: moveX, y: moveY}));
                moveX = 0; moveY = 0;
                isMoving = false;
            }
        }, 16);

        const pad = document.getElementById('touchpad');
        let lastX = 0, lastY = 0;
        let touchActive = false;

        pad.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchActive = true;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            moveX = 0; moveY = 0;
        }, {passive: false});

        pad.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!touchActive) return;
            const cx = e.touches[0].clientX;
            const cy = e.touches[0].clientY;
            moveX += (cx - lastX);
            moveY += (cy - lastY);
            isMoving = true;
            lastX = cx;
            lastY = cy;
        }, {passive: false});

        pad.addEventListener('touchend', (e) => { e.preventDefault(); touchActive = false; }, {passive: false});
        pad.addEventListener('touchcancel', (e) => { touchActive = false; }, {passive: false});

        // --- GESTIONE SCROLL (Alta Sensibilit√†) ---
        let scrollAccumulator = 0;
        const scrollbar = document.getElementById('scrollbar');
        let scrollTouchActive = false;
        let scrollLastY = 0;

        setInterval(() => {
            if (scrollTouchActive && ws && ws.readyState === WebSocket.OPEN && Math.abs(scrollAccumulator) >= 1) {
                const scrollAmount = Math.round(scrollAccumulator / 1.5); 
                if (scrollAmount !== 0) {
                    ws.send(JSON.stringify({type: 'scroll', amount: scrollAmount}));
                }
                scrollAccumulator = 0;
            }
        }, 16);

        scrollbar.addEventListener('touchstart', (e) => {
            e.preventDefault();
            scrollTouchActive = true;
            scrollLastY = e.touches[0].clientY;
            scrollAccumulator = 0;
        }, {passive: false});

        scrollbar.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!scrollTouchActive) return;
            const cy = e.touches[0].clientY;
            const delta = cy - scrollLastY;
            scrollAccumulator += delta * 3.0; // Moltiplicatore sensibilit√†
            scrollLastY = cy;
        }, {passive: false});

        scrollbar.addEventListener('touchend', (e) => { e.preventDefault(); scrollTouchActive = false; }, {passive: false});
        scrollbar.addEventListener('touchcancel', (e) => { scrollTouchActive = false; }, {passive: false});

        // --- CONTROLLI E PULSANTI ---
        const sendClick = (btn) => {
            if(ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'click', btn: btn}));
            }
        };

        document.getElementById('btn-left').addEventListener('click', () => sendClick('left'));
        document.getElementById('btn-right').addEventListener('click', () => sendClick('right'));

        // Logica Drag & Drop
        const btnDrag = document.getElementById('btn-drag');
        let isDragging = false;

        btnDrag.addEventListener('click', () => {
            isDragging = !isDragging;
            if (isDragging) {
                btnDrag.classList.add('drag-active');
                if(ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'drag', state: 'down'}));
                }
                if (navigator.vibrate) navigator.vibrate(50);
            } else {
                btnDrag.classList.remove('drag-active');
                if(ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'drag', state: 'up'}));
                }
            }
        });

        // Logica Select All (Ctrl+A)
        document.getElementById('btn-select-all').addEventListener('click', () => {
            if(ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'hotkey', keys: ['ctrl', 'a']}));
                if (navigator.vibrate) navigator.vibrate(30);
                updateTextDisplay("SELEZIONA TUTTO");
            }
        });

        document.getElementById('btn-keyboard').addEventListener('click', () => {
            hiddenInput.value = '';
            hiddenInput.focus();
        });

        // --- FEEDBACK VISIVO TESTO ---
        const textDisplay = document.getElementById('text-display');
        let displayedText = '';
        let displayTimeout;

        function updateTextDisplay(char) {
            if (char.length > 1) displayedText = char;
            else if (char === '‚å´') displayedText = displayedText.slice(0, -1);
            else if (char === '‚Üµ') displayedText += '\n';
            else displayedText += char;
            
            textDisplay.textContent = displayedText;
            textDisplay.classList.add('active');
            
            clearTimeout(displayTimeout);
            displayTimeout = setTimeout(() => {
                textDisplay.classList.remove('active');
                displayedText = '';
            }, 3000);
        }

        // --- INPUT TASTIERA ---
        let previousValue = '';
        hiddenInput.addEventListener('input', (e) => {
            if(!ws || ws.readyState !== WebSocket.OPEN) return;
            const currentValue = hiddenInput.value;
            
            if (currentValue.length > previousValue.length) {
                const addedChar = currentValue.substring(previousValue.length);
                for (let char of addedChar) {
                    ws.send(JSON.stringify({type: 'text', char: char}));
                    updateTextDisplay(char);
                }
            } else if (currentValue.length < previousValue.length) {
                const deletedCount = previousValue.length - currentValue.length;
                for (let i = 0; i < deletedCount; i++) {
                    ws.send(JSON.stringify({type: 'key', key: 'backspace'}));
                    updateTextDisplay('‚å´');
                }
            }
            previousValue = currentValue;
        });

        hiddenInput.addEventListener('keydown', (e) => {
            if(!ws || ws.readyState !== WebSocket.OPEN) return;
            if (e.key === 'Enter') {
                e.preventDefault();
                ws.send(JSON.stringify({type: 'key', key: 'enter'}));
                updateTextDisplay('‚Üµ');
                previousValue = '';
                hiddenInput.value = '';
            } else if (e.key === 'Backspace') {
                setTimeout(() => {
                    if (hiddenInput.value === previousValue) {
                        ws.send(JSON.stringify({type: 'key', key: 'backspace'}));
                        updateTextDisplay('‚å´');
                    }
                }, 10);
            }
        });

        // --- EFFETTI UI ---
        function attachPressEffect(id) {
            const el = document.getElementById(id);
            const add = () => el.classList.add('fluid-pressed');
            const remove = () => el.classList.remove('fluid-pressed');
            el.addEventListener('touchstart', add, {passive: true});
            el.addEventListener('touchend', remove, {passive: true});
            el.addEventListener('touchcancel', remove, {passive: true});
        }

        attachPressEffect('btn-left');
        attachPressEffect('btn-right');
        attachPressEffect('btn-keyboard');
        attachPressEffect('btn-drag');
        attachPressEffect('btn-select-all');
        attachPressEffect('touchpad');
        attachPressEffect('scrollbar');

    </script>
</body>
</html>